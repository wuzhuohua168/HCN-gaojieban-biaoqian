<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è´§è¿è´¹ç”¨ç”Ÿæˆç³»ç»Ÿ v3.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --main-purple: #5d5bd4; --bg-gray: #f0f2f5; }
        body { font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif; background: var(--bg-gray); margin: 0; padding: 20px; }

        /* é…ç½®é¢æ¿ */
        .config-panel { 
            max-width: 1000px; 
            margin: 0 auto 30px; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .config-header { grid-column: 1 / -1; border-bottom: 2px solid var(--bg-gray); padding-bottom: 10px; margin-bottom: 10px; }
        .config-header h3 { margin: 0; color: var(--main-purple); }

        .input-item label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: #555; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 100px; }

        .action-area { grid-column: 1 / -1; display: flex; gap: 15px; margin-top: 10px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; color: white; transition: 0.2s; }
        .btn-preview { background: var(--main-purple); }
        .btn-pdf { background: #27ae60; }
        .btn-csv { background: #2980b9; }

        /* é¢„è§ˆåŒº - A4 æ¯”ä¾‹ */
        .report-container { display: flex; justify-content: center; padding-bottom: 50px; }
        .report-wrap { 
            width: 794px; 
            background: white; 
            padding: 60px 50px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            box-sizing: border-box; 
            min-height: 1123px;
            display: flex;
            flex-direction: column;
        }

        .report-content { flex-grow: 1; }
        .report-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
        .brand { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .logo-img { width: 45px; height: 45px; }
        .logo-img img { width: 100%; height: 100%; object-fit: contain; }
        .company-cn { font-size: 26px; font-weight: bold; margin: 0; }
        .company-en { font-size: 9.5px; font-weight: bold; letter-spacing: 0.5px; }
        
        .doc-name { text-align: center; font-size: 24px; font-weight: bold; margin: 40px 0; letter-spacing: 6px; text-decoration: underline; text-underline-offset: 10px; }
        .meta-box { font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        
        .route-info { background: #f8f9ff; border-left: 5px solid var(--main-purple); padding: 15px 20px; margin-bottom: 30px; }
        .route-title { font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px; }
        .route-detail { font-size: 13px; color: #666; }

        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; table-layout: fixed; }
        .main-table th { background: #f5f5f5; border: 1px solid #d0d0d0; padding: 12px 5px; font-size: 11px; }
        .main-table td { border: 1px solid #d0d0d0; padding: 15px 5px; font-size: 12px; text-align: center; word-break: break-all; }
        .sum-line { text-align: right; font-weight: bold; padding-right: 15px !important; }

        .fee-table { width: 100%; border: 1px solid #000; margin-top: 20px; }
        .fee-row { display: flex; border-bottom: 1px solid #000; }
        .fee-row:last-child { border-bottom: none; }
        .fee-head { width: 120px; background: #f5f5f5; padding: 15px; font-weight: bold; border-right: 1px solid #000; font-size: 14px; }
        .fee-body { padding: 15px; flex: 1; font-size: 16px; }

        .report-footer { text-align: center; margin-top: 50px; border-top: 1px solid #eee; padding-top: 15px; }
        .footer-line-1 { font-size: 10px; color: #999; letter-spacing: 0.5px; margin-bottom: 4px; }
        .footer-line-2 { font-size: 9px; color: #bbb; }
    </style>
</head>
<body>

<div class="config-panel">
    <div class="config-header"><h3>1. é…ç½®ä¿¡æ¯</h3></div>
    <div class="input-item"><label>ä¸Šä¼  Logo</label><input type="file" id="upLogo" accept="image/*"></div>
    <div class="input-item"><label>å…¬å¸ä¸­è‹±åç§°</label>
        <input type="text" id="inCn" value="åˆè¾°ä¾›åº”é“¾ï¼ˆæ·±åœ³ï¼‰æœ‰é™å…¬å¸">
        <input type="text" id="inEn" value="HCN SUPPLY CHAIN (SHENZHEN) CO., LTD." style="margin-top:5px">
    </div>
    <div class="input-item"><label>å®¢æˆ·åç§°</label><input type="text" id="inCust" placeholder="å®¢æˆ·å§“å"></div>
    <div class="input-item"><label>è·¯çº¿è®¾ç½® (ä¾‹å¦‚: å‡ºå‘ â†’ ç›®çš„åœ°)</label><input type="text" id="inRoute" value="ä¸­å›½ğŸ‡¨ğŸ‡³ â†’ æ—¥æœ¬ğŸ‡¯ğŸ‡µ"></div>
    <div class="input-item"><label>è¿è¾“æ–¹å¼</label><input type="text" id="inShip" value="ç©ºè¿"></div>
    <div class="input-item"><label>æ™ºèƒ½è¯†åˆ«ä¿¡æ¯</label><textarea id="inSmart" placeholder="åœ¨æ­¤ç²˜è´´å•å·ç­‰ä¿¡æ¯..."></textarea></div>
    <div class="input-item"><label>è¡¨æ ¼å¤‡æ³¨ (å«é™„åŠ è´¹)</label><input type="text" id="inTableNote" placeholder="ä¾‹å¦‚ï¼šæŠ¥å…³è´¹100"></div>
    <div class="input-item"><label>æŠ¥ä»·å•ä»· (Â¥/kg)</label><input type="number" id="inPrice" value="" step="0.01"></div>
    
    <div class="action-area">
        <button class="btn-preview" onclick="doUpdate()">â‘  æ›´æ–°é¢„è§ˆå†…å®¹</button>
        <button class="btn-pdf" onclick="processFile('pdf')">â‘¡ åˆ†äº«/ä¸‹è½½ PDF</button>
        <button class="btn-csv" onclick="processFile('csv')">â‘¢ åˆ†äº«/ä¸‹è½½ CSV</button>
    </div>
</div>

<div class="report-container">
    <div class="report-wrap" id="capture-area">
        <div class="report-content">
            <div class="report-header">
                <div class="brand">
                    <div class="logo-img" id="outLogo">HCN</div>
                    <div class="company-cn" id="outCn">åˆè¾°ä¾›åº”é“¾ï¼ˆæ·±åœ³ï¼‰æœ‰é™å…¬å¸</div>
                </div>
                <div class="company-en" id="outEn">HCN SUPPLY CHAIN (SHENZHEN) CO., LTD.</div>
            </div>
            <h2 class="doc-name">è´§è¿è´¹ç”¨ç¡®è®¤å•</h2>
            <div class="meta-box">
                <span><b>è¿å•å·ï¼š</b> <span id="outNo">-</span></span>
                <span><b>æ—¥æœŸï¼š</b> <span id="outDate">-</span></span>
            </div>
            <div class="route-info">
                <span class="route-title" id="outRoute">ä¸­å›½ğŸ‡¨ğŸ‡³ â†’ æ—¥æœ¬ğŸ‡¯ğŸ‡µ</span>
                <span class="route-detail" id="outDesc">è¿è¾“æ–¹å¼ï¼šç©ºè¿ | å®¢æˆ·ï¼š-</span>
            </div>
            <table class="main-table">
                <thead>
                    <tr>
                        <th width="22%">å•å·</th>
                        <th width="12%">ä½“ç§¯(mÂ³)</th>
                        <th width="12%">é‡é‡(KG)</th>
                        <th width="12%">è®¡è´¹é‡</th>
                        <th width="8%">æ•°é‡</th>
                        <th width="14%">å“å</th>
                        <th width="20%">å¤‡æ³¨</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td>-</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0</td><td>-</td><td>-</td></tr>
                </tbody>
                <tfoot>
                    <tr><td colspan="7" class="sum-line" id="outSum">æ±‡æ€»ï¼š0ä»¶ / 0.00kg</td></tr>
                </tfoot>
            </table>
            <div class="fee-table">
                <div class="fee-row"><div class="fee-head">æ”¶è´¹å•ä»·ï¼ˆRMBï¼‰</div><div class="fee-body" id="outUnitPrice">Â¥0.00 / kg</div></div>
                <div class="fee-row"><div class="fee-head">åº”ä»˜åˆè®¡ï¼ˆRMBï¼‰</div><div class="fee-body" style="font-weight:bold; font-size:20px; color:#d63031;" id="outTotal">Â¥0.00</div></div>
            </div>
        </div>
        <div class="report-footer">
            <div class="footer-line-1">æ­¤è¿å•ç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¢æœæˆ–è€…ä¸šåŠ¡ã€‚</div>
            <div class="footer-line-2">ç”Ÿæˆæ—¶é—´ï¼š<span id="outGenAt">-</span></div>
        </div>
    </div>
</div>

<script>
    let globalData = { cust: 'å®¢æˆ·', no: 'å•å·', qty: 0 };

    document.getElementById('upLogo').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => { document.getElementById('outLogo').innerHTML = `<img src="${ev.target.result}">`; };
            reader.readAsDataURL(file);
        }
    };

    function doUpdate() {
        const text = document.getElementById('inSmart').value;
        const price = parseFloat(document.getElementById('inPrice').value) || 0;
        const tableNote = document.getElementById('inTableNote').value || "-";
        const customRoute = document.getElementById('inRoute').value || "æœªå¡«å†™è·¯çº¿";
        
        const orderNo = (text.match(/(?:HET|SHIP-|å•å·)[:ï¼š]?\s*([A-Z0-9\-]+)/i) || ["", "æœªè¯†åˆ«"])[1];
        const billWeight = parseFloat((text.match(/(?:è®¡è´¹é‡|è®¡è´¹é‡é‡)[:ï¼š]?\s*(\d+(\.\d+)?)/) || ["", 0])[1]);
        const actWeight = parseFloat((text.match(/(?:å®é™…é‡é‡|é‡é‡)[:ï¼š]?\s*(\d+(\.\d+)?)/) || ["", 0])[1]);
        const volume = (text.match(/(?:ä½“ç§¯|å®é™…ä½“ç§¯)[:ï¼š]?\s*(\d+(\.\d+)?)/) || ["", "0.00"])[1];
        const qty = parseInt((text.match(/(?:ä»¶æ•°[:ï¼š]\s*|==)(\d+)/) || ["", 0])[1]);
        const product = (text.match(/(?:å“å[:ï¼š]\s*)(\S+)/) || ["", "æœªè¯†åˆ«"])[1];

        let extraFee = 0;
        const feeMatch = tableNote.match(/\d+(\.\d+)?/);
        if (feeMatch) extraFee = parseFloat(feeMatch[0]);
        const total = (billWeight * price) + extraFee;

        globalData = { 
            cust: document.getElementById('inCust').value || "å®¢æˆ·", 
            no: orderNo, 
            vol: volume, 
            actW: actWeight.toFixed(2), 
            billW: billWeight.toFixed(2), 
            qty: qty, 
            pro: product, 
            note: tableNote,
            price: price.toFixed(2),
            total: total.toLocaleString('zh-CN', {minimumFractionDigits: 2})
        };

        // æ›´æ–°é¢„è§ˆå†…å®¹
        document.getElementById('outCn').innerText = document.getElementById('inCn').value;
        document.getElementById('outEn').innerText = document.getElementById('inEn').value;
        document.getElementById('outNo').innerText = orderNo;
        document.getElementById('outDate').innerText = new Date().toLocaleDateString('zh-CN');
        
        // æ›´æ–°è·¯çº¿ä¸ºç”¨æˆ·è¾“å…¥çš„å†…å®¹
        document.getElementById('outRoute').innerText = customRoute;
        
        document.getElementById('outDesc').innerText = `è¿è¾“æ–¹å¼ï¼š${document.getElementById('inShip').value} | å®¢æˆ·ï¼š${globalData.cust}`;
        document.getElementById('tableBody').innerHTML = `<tr><td>${orderNo}</td><td>${volume}</td><td>${actWeight.toFixed(2)}</td><td>${billWeight.toFixed(2)}</td><td>${qty}</td><td>${product}</td><td>${tableNote}</td></tr>`;
        document.getElementById('outSum').innerText = `æ±‡æ€»ï¼š${qty}ä»¶ / ${billWeight.toFixed(2)}kg`;
        document.getElementById('outUnitPrice').innerText = `Â¥${price.toFixed(2)} / kg`;
        document.getElementById('outTotal').innerText = `Â¥${globalData.total}`;
        document.getElementById('outGenAt').innerText = new Date().toLocaleString();
    }

    async function processFile(type) {
        if (!globalData.no || globalData.no === 'å•å·') { alert("è¯·å…ˆç‚¹å‡»ã€æ›´æ–°é¢„è§ˆå†…å®¹ã€‘"); return; }
        
        const d = new Date();
        const dateStr = `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`;
        const fileName = `${globalData.cust}_${globalData.no}_${globalData.qty}ä»¶_æŠ¥ä»·å•_${dateStr}.${type}`;
        
        let blob;
        if (type === 'pdf') {
            const element = document.getElementById('capture-area');
            const canvas = await html2canvas(element, { scale: 2.5, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = (canvas.height * pageWidth) / canvas.width;
            pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
            blob = pdf.output('blob');
        } else {
            const csvRows = [
                ["å®¢æˆ·åç§°", "è¿å•å·", "ä½“ç§¯(m3)", "é‡é‡(kg)", "è®¡è´¹é‡(kg)", "ä»¶æ•°", "å“å", "å¤‡æ³¨", "å•ä»·", "æ€»è®¡(å…ƒ)"],
                [globalData.cust, globalData.no, globalData.vol, globalData.actW, globalData.billW, globalData.qty, globalData.pro, globalData.note, globalData.price, globalData.total]
            ];
            const csvString = "\ufeff" + csvRows.map(row => row.map(v => `"${v}"`).join(",")).join("\n");
            blob = new Blob([csvString], { type: "text/csv;charset=utf-8" });
        }

        const file = new File([blob], fileName, { type: blob.type });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({ files: [file], title: fileName });
            } catch (err) {
                if (err.name !== 'AbortError') downloadLocal(blob, fileName);
            }
        } else {
            downloadLocal(blob, fileName);
        }
    }

    function downloadLocal(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
